<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>แดชบอร์ด</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{background:#f8f9fa}
  .d-flex{min-height:100vh}
  .sidebar{
    background:#6f42c1;color:#fff;
    width:220px;flex:0 0 220px;
    padding:20px;position:sticky;top:0;height:100vh;
  }
  .sidebar a{color:#fff;text-decoration:none;display:block;margin:.45rem 0}
  .content{flex:1;min-width:0;padding:20px}
  .card-lite{background:#f3effc;border-radius:10px;padding:14px}
  .big{font-size:28px;font-weight:700;color:#6f42c1}
</style>
</head>
<body>
<div class="d-flex">
  <div class="sidebar">
    <h4>เมนู</h4>
    <a href="dashboard.html">แดชบอร์ด</a>
    <a href="user-management.html">จัดการสมาชิก</a>
    <a href="vehicle-management.html">จัดการรถ</a>
    <a href="entry-exit-log.html">บันทึกเข้า-ออก</a>
    <a href="statistics.html">สถิติ</a>
    <a href="error-log.html">บันทึกผิดปกติ</a>
    <a id="logout" href="#">ออกจากระบบ</a>
  </div>

  <div class="content">
    <h3 class="mb-3">ภาพรวมระบบ</h3>

    <div class="row g-3">
      <div class="col-md-3"><div class="card-lite">ผู้ใช้งาน <div id="u" class="big">-</div></div></div>
      <div class="col-md-3"><div class="card-lite">รถลงทะเบียน <div id="v" class="big">-</div></div></div>
      <div class="col-md-3"><div class="card-lite">บันทึกวันนี้ <div id="t" class="big">-</div></div></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getCountFromServer, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyDtebmJ8TIw_fYk6c-wxYn747njdystYLY",authDomain:"motodetec-entry-exit.firebaseapp.com",projectId:"motodetec-entry-exit",storageBucket:"motodetec-entry-exit.firebasestorage.app",messagingSenderId:"196015620727",appId:"1:196015620727:web:f2991268c91e41f2ee3c72",measurementId:"G-XN3QFKMB4J"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

onAuthStateChanged(auth, async(u)=>{ if(!u){location.href="login.html";return;} load(); });
document.getElementById('logout').addEventListener('click',async e=>{e.preventDefault();await signOut(auth);location.href="login.html";});

async function load(){
  const users = await getCountFromServer(collection(db,'users'));
  const plates = await getCountFromServer(collection(db,'license_plates'));
  const d=new Date(); d.setHours(0,0,0,0); const e=new Date(d); e.setDate(e.getDate()+1);
  const todayQ=query(collection(db,'attendance'),where('time','>=',Timestamp.fromDate(d)),where('time','<',Timestamp.fromDate(e)));
  const today = await getCountFromServer(todayQ);

  document.getElementById('u').textContent=users.data().count;
  document.getElementById('v').textContent=plates.data().count;
  document.getElementById('t').textContent=today.data().count;
}
</script>
</body>
</html>
