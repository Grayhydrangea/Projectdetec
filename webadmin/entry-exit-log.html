<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>บันทึกเข้า-ออก</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{background:#f8f9fa}
  .d-flex{min-height:100vh}
  .sidebar{
    background:#6f42c1;color:#fff;
    width:220px;flex:0 0 220px;
    padding:20px;position:sticky;top:0;height:100vh;
  }
  .sidebar a{color:#fff;text-decoration:none;display:block;margin:.45rem 0}
  .content{flex:1;min-width:0;padding:20px}
  .summary .box{background:#f3effc;border-radius:10px;padding:10px}
  .summary .num{font-weight:700;color:#6f42c1}
</style>
</head>
<body>
<div class="d-flex">
  <div class="sidebar">
    <h4>เมนู</h4>
    <a href="dashboard.html">แดชบอร์ด</a>
    <a href="user-management.html">จัดการสมาชิก</a>
    <a href="vehicle-management.html">จัดการรถ</a>
    <a href="entry-exit-log.html">บันทึกเข้า-ออก</a>
    <a href="statistics.html">สถิติ</a>
    <a href="error-log.html">บันทึกผิดปกติ</a>
    <a id="logout" href="#">ออกจากระบบ</a>
  </div>

  <div class="content">
    <h3 class="mb-3">บันทึกเข้า-ออก</h3>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="tab">
      <li class="nav-item"><button class="nav-link active" data-status="">ทั้งหมด</button></li>
      <li class="nav-item"><button class="nav-link" data-status="entry">เข้า</button></li>
      <li class="nav-item"><button class="nav-link" data-status="exit">ออก</button></li>
    </ul>

    <!-- Filters -->
    <div class="row g-2 mb-2">
      <div class="col-md-3"><input id="datePick" type="date" class="form-control"></div>
      <div class="col-md-3">
        <!-- ใช้ค่า gate1/gate2/gate3 ให้ตรงกับ DB -->
        <select id="selLoc" class="form-select">
          <option value="">ทุกประตู</option>
          <option value="gate1">ประตู1</option>
          <option value="gate2">ประตู2</option>
          <option value="gate3">ประตู3</option>
        </select>
      </div>
      <div class="col-md-3"><input id="qPlate" class="form-control" placeholder="ค้นหาป้ายทะเบียน..."></div>
      <div class="col-md-2"><button id="btnLoad" class="btn btn-primary w-100">โหลด</button></div>
    </div>

    <!-- Summary -->
    <div class="card p-3 mb-3 summary">
      <div class="row g-3">
        <div class="col-md-3"><div class="box">เข้า: <span id="cEntry" class="num">0</span></div></div>
        <div class="col-md-3"><div class="box">ออก: <span id="cExit" class="num">0</span></div></div>
        <div class="col-md-3"><div class="box">รวม: <span id="cSum" class="num">0</span></div></div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead><tr><th>เวลา</th><th>สถานะ</th><th>ทะเบียน</th><th>สถานที่</th><th>UID</th></tr></thead>
        <tbody id="rows"><tr><td colspan="5">ไม่พบข้อมูล</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyDtebmJ8TIw_fYk6c-wxYn747njdystYLY",authDomain:"motodetec-entry-exit.firebaseapp.com",projectId:"motodetec-entry-exit",storageBucket:"motodetec-entry-exit.firebasestorage.app",messagingSenderId:"196015620727",appId:"1:196015620727:web:f2991268c91e41f2ee3c72",measurementId:"G-XN3QFKMB4J"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentStatus=""; // '', 'entry', 'exit'

/* --- normalize ชื่อประตูให้เป็นรูปแบบเดียวกัน --- */
function normalizeLocation(x){
  const v = (x||'').toString().trim().toLowerCase();
  if (!v) return '';
  if (v === 'gate1_side' || v === 'gate2' || v === '2' || v === 'ประตู2') return 'gate2';
  if (v === 'gate1' || v === '1' || v === 'ประตู1') return 'gate1';
  if (v === 'gate3' || v === '3' || v === 'ประตู3') return 'gate3';
  // เผื่อมีรูปแบบอื่น ๆ ก็ส่งกลับค่าดิบ
  return v;
}

onAuthStateChanged(auth,(u)=>{ if(!u){location.href="login.html";return;} document.getElementById('datePick').valueAsDate=new Date(); });

document.getElementById('logout').addEventListener('click', async e=>{e.preventDefault();await signOut(auth);location.href="login.html";});
document.getElementById('btnLoad').addEventListener('click', load);
document.getElementById('qPlate').addEventListener('input', ()=>render(_rowsCache));

document.querySelectorAll('#tab .nav-link').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#tab .nav-link').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentStatus = (btn.dataset.status||"").toLowerCase();
    render(_rowsCache);
  });
});

function getRange(){
  const d=document.getElementById('datePick').valueAsDate || new Date();
  d.setHours(0,0,0,0); const e=new Date(d); e.setDate(e.getDate()+1); return [d,e];
}

let _rowsCache=[];
async function load(){
  const [start,end]=getRange();
  const qy=query(collection(db,'attendance'),
    where('time','>=',Timestamp.fromDate(start)),
    where('time','<', Timestamp.fromDate(end)),
    orderBy('time','desc'));
  const snap=await getDocs(qy);
  _rowsCache=[];
  snap.forEach(doc=>{
    const m=doc.data();
    _rowsCache.push({
      t: m.time?.toDate?.()||null,
      s: (m.status||'-').toLowerCase(),
      p: m.licensePlate||m.plateNormalized||'-',
      l: normalizeLocation(m.locationId||m.location||'-'),
      u: m.uid||'-'
    });
  });
  render(_rowsCache);
}

function render(list){
  const locSel = normalizeLocation(document.getElementById('selLoc').value);
  const q      = (document.getElementById('qPlate').value||'').trim().toLowerCase();

  let e=0,x=0;
  const filtered = list.filter(r=>{
    if(currentStatus && r.s!==currentStatus) return false;
    if(locSel && r.l!==locSel) return false;           // เทียบหลัง normalize แล้ว
    if(q && !((r.p||'').toLowerCase().includes(q))) return false;
    if(r.s==='entry') e++; else if(r.s==='exit') x++;
    return true;
  });

  document.getElementById('cEntry').textContent=e;
  document.getElementById('cExit').textContent=x;
  document.getElementById('cSum').textContent=e+x;

  const tb=document.getElementById('rows'); tb.innerHTML="";
  if(filtered.length===0){ tb.innerHTML=`<tr><td colspan="5">ไม่พบข้อมูล</td></tr>`; return; }

  filtered.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.t? r.t.toLocaleString('th-TH'):'-'}</td>
      <td class="text-capitalize">${r.s}</td>
      <td>${r.p}</td>
      <td>${r.l}</td>
      <td>${r.u}</td>`;
    tb.appendChild(tr);
  });
}
</script>
</body>
</html>
