<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>จัดการรถ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{background:#f8f9fa}
  .d-flex{min-height:100vh}
  .sidebar{
    background:#6f42c1;color:#fff;
    width:220px;flex:0 0 220px;
    padding:20px;position:sticky;top:0;height:100vh;
  }
  .sidebar a{color:#fff;text-decoration:none;display:block;margin:.45rem 0}
  .content{flex:1;min-width:0;padding:20px}
</style>
</head>
<body>
<div class="d-flex">
  <div class="sidebar">
    <h4>เมนู</h4>
    <a href="dashboard.html">แดชบอร์ด</a>
    <a href="user-management.html">จัดการสมาชิก</a>
    <a href="vehicle-management.html">จัดการรถ</a>
    <a href="entry-exit-log.html">บันทึกเข้า-ออก</a>
    <a href="statistics.html">สถิติ</a>
    <a href="error-log.html">บันทึกผิดปกติ</a>
    <a id="logout" href="#">ออกจากระบบ</a>
  </div>

  <div class="content">
    <h3 class="mb-3">จัดการรถ / ป้ายทะเบียน</h3>
    <div class="mb-3"><input id="search" class="form-control" placeholder="ค้นหาเลขทะเบียน..."></div>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead><tr><th>เลขทะเบียน</th><th>เจ้าของ</th><th>ลงทะเบียนเมื่อ</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyDtebmJ8TIw_fYk6c-wxYn747njdystYLY",authDomain:"motodetec-entry-exit.firebaseapp.com",projectId:"motodetec-entry-exit",storageBucket:"motodetec-entry-exit.firebasestorage.app",messagingSenderId:"196015620727",appId:"1:196015620727:web:f2991268c91e41f2ee3c72",measurementId:"G-XN3QFKMB4J"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let rowsCache=[];

onAuthStateChanged(auth, async(u)=>{ if(!u){location.href="login.html";return;} await load(); });
document.getElementById('logout').addEventListener('click', async (e)=>{ e.preventDefault(); await signOut(auth); location.href="login.html"; });

async function load(){
  const tb=document.getElementById('rows');
  tb.innerHTML=`<tr><td colspan="3">กำลังโหลด...</td></tr>`;
  const snap=await getDocs(collection(db,'license_plates'));
  rowsCache=[];
  for(const d of snap.docs){
    const m=d.data();
    const uid=m.ownerUid||null;
    let ownerName='-';
    if(uid){
      const uDoc=await getDoc(doc(db,'users',uid));
      ownerName=uDoc.exists()? (uDoc.data().name||uid) : uid;
    }
    rowsCache.push({plate:m.plate||d.id, owner:ownerName, time:m.registeredAt?.toDate?.()||null});
  }
  render(rowsCache);
}

function render(list){
  const tb=document.getElementById('rows'); tb.innerHTML="";
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.plate}</td><td>${r.owner}</td><td>${r.time? r.time.toLocaleString('th-TH'):'-'}</td>`;
    tb.appendChild(tr);
  });
}

document.getElementById('search').addEventListener('input', e=>{
  const q=e.target.value.trim().toLowerCase();
  render(rowsCache.filter(x=>(x.plate||"").toLowerCase().includes(q)|| (x.owner||"").toLowerCase().includes(q)));
});
</script>
</body>
</html>
